<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./index.css">
  <title>uploader</title>
</head>

<body>
  <div id="w-uploader">
    <div id="file-list-wrapper"></div>
    <label id="w-uploader-trigger">
      <div class="uploader-process">
        <div class="process-text">上传中...</div>
        <div class="process-bar"></div>
      </div>
      <input type="file" accept="image/*" id="trigger-input">
    </label>
  </div>
  <script src="./index.js"></script>
  <script>
    const imgItem = `
      <div class="img-item" style="width:200px;height:200px;">
        <img src="__preview__" style="width:100%;height:100%;object-fit:contain;" >  
      <div>
    `
    const action = `http://client2.365hy.com/niumore123456/upload`
    const _ = sel => document.querySelector(sel)
    const xhr = createXhr()
    let preview = null
    const $uploader = {
      trigger: _('#w-uploader-trigger'),
      input: _('#trigger-input'),
      process: _('.uploader-process'),
      processBar: _('.process-bar'),
      fileListWrapper: _('#file-list-wrapper')
    }
    $uploader.input.addEventListener('change', e => {
      const file = e.target.files[0]
      createPreview(file)
      const formData = new FormData
      formData.append('file', file)
      xhr.send(formData)
    })

    function createPreview(file) {
      const f = new FileReader()
      f.readAsDataURL(file)
      f.onload = e => {
        preview = e.target.result
      }
    }

    function createXhr() {
      const xhr = new XMLHttpRequest
      xhr.upload.addEventListener('progress', e => {
        if (e.lengthComputable) {
          const percent = e.loaded / e.total * 100
          if (percent >= 20) {
            $uploader.processBar.classList.add('p-2')
          } else if (percent > 20 && percent <= 40) {
            $uploader.processBar.classList.add('p-4')
          }
          else if (percent > 40 && percent <= 60) {
            $uploader.processBar.classList.add('p-6')
          }
          else if (percent > 60 && percent <= 80) {
            $uploader.processBar.classList.add('p-8')
          }
          else if (percent === 100) {
            $uploader.processBar.classList.add('p-10')
          }
        }
      })
      xhr.onload = e => {
        $uploader.processBar.classList.add('p-10')
        setTimeout(() => {
          $uploader.process.style.display = 'none'
        }, 300);
        const res = JSON.parse(e.target.response)
        console.log(preview);
        const img = imgItem.replace('__preview__', preview)
        $uploader.fileListWrapper.innerHTML = img
      }
      xhr.open('POST', action)
      return xhr
    }
  </script>
</body>

</html>