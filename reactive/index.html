<script>
  let usedReactivities = []
  const handlers = new Map()
  const reactivities = new Map()

  function reactive(obj) {
    if (reactivities.get(obj)) return reactivities.get(obj)

    const proxy = new Proxy(obj, {
      get(obj, prop) {
        usedReactivities.push([obj, prop])
        if (typeof prop === 'object' && prop) return reactive(obj[prop]) // 递归
        return obj[prop]
      },
      set(obj, prop, val) {
        obj[prop] = val
        handlers.get(obj)?.get(prop)?.forEach(handler => handler())
        return obj[prop]
      }
    })
    // 缓存同一对象的proxy
    reactivities.set(obj, proxy)
    reactivities.set(proxy, proxy)
    return proxy
  }

  function effect(handler) {
    usedReactivities = []
    handler()
    for (const reactivity of usedReactivities) {
      const [obj, prop] = reactivity
      if (!handlers.get(obj)) {
        handlers.set(obj, new Map())
      }
      if (!handlers.get(obj).get(prop)) {
        handlers.get(obj).set(prop, new Set())
      }
      handlers.get(obj).get(prop).add(handler)
    }
  }

  let dummy
  const counter = reactive({ num: 0 })
  effect(() => (dummy = counter.num))
  console.log(dummy);
  counter.num = 1
  console.log(dummy);

</script>